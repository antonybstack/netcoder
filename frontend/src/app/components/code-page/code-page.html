<div class="flex flex-col gap-6 p-6">
  <section class="space-y-4">
    <header class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-wrap items-center gap-2">
        <button class="btn btn-primary" type="button" (click)="run()">Run</button>
        <button class="btn btn-outline" type="button" (click)="clear()">Clear History</button>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span class="badge badge-secondary">
          Intellisense:
          <strong class="ml-1 capitalize">{{ status().status }}</strong>
        </span>
        @if (status().localOnly) {
        <span class="badge badge-warning badge-outline">local-only</span>
        }
        @if (inflight() > 0) {
        <span class="badge badge-info badge-outline animate-pulse">Running ({{ inflight() }})</span>
        }
      </div>
    </header>
    <div class="rounded-2xl border border-base-300 bg-base-200/60 p-2 shadow-inner">
      <div
        #editor
        aria-label="C# editor"
        class="code-editor rounded-xl bg-base-200/40"
      ></div>
    </div>
  </section>

  <section class="grid gap-4 lg:grid-cols-3">
    <article class="card bg-base-100 shadow">
      <div class="card-body space-y-2">
        <h3 class="card-title text-base">Realtime Status</h3>
        <p class="text-sm text-base-content/70">
          {{ status().message || 'Listening for completions, diagnostics, hover, and signature help events.' }}
        </p>
        <div>
          <p class="text-xs uppercase text-base-content/60">Last completions</p>
          @if (completions().length === 0) {
          <p class="text-sm text-base-content/60">Waiting for input…</p>
          } @else {
          <ul class="space-y-1 text-sm">
            @for (item of completions().slice(0, 4); track item.label) {
            <li class="flex items-center justify-between gap-2">
              <span class="font-mono text-xs text-primary">{{ item.label }}</span>
              <span class="text-xs text-base-content/60">{{ item.detail || item.kind }}</span>
            </li>
            }
          </ul>
          }
        </div>
      </div>
    </article>

    <article class="card bg-base-100 shadow">
      <div class="card-body space-y-2">
        <h3 class="card-title text-base">Diagnostics</h3>
        @if (diagnosticsFeed().length === 0) {
        <p class="text-sm text-base-content/60">No diagnostics yet.</p>
        } @else {
        <ul class="space-y-1">
          @for (diag of diagnosticsFeed(); track diag.code + diag.range.start) {
          <li class="rounded-lg border border-base-200 p-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="font-semibold">{{ diag.severity }}</span>
              <span class="text-xs text-base-content/60">L{{ diag.range.start }}-{{ diag.range.end }}</span>
            </div>
            <p class="text-base-content/80">{{ diag.message }}</p>
          </li>
          }
        </ul>
        }
      </div>
    </article>

    <article class="card bg-base-100 shadow">
      <div class="card-body space-y-2">
        <h3 class="card-title text-base">Hover &amp; Signature</h3>
        @if (hoverInfo()) {
        <div class="rounded-lg bg-base-200/60 p-2 text-sm">
          <p class="font-mono text-xs whitespace-pre-wrap">{{ hoverInfo()!.contents }}</p>
        </div>
        } @else {
        <p class="text-sm text-base-content/60">Move the caret over a symbol to view hover info.</p>
        }

        @if (signatureHelp()) {
        <div class="rounded-lg border border-base-200 p-2 text-sm">
          <p class="font-semibold">{{ signatureHelp()!.signatures[signatureHelp()!.activeSignature]?.label }}</p>
          <p class="text-xs text-base-content/60">
            Active parameter: {{ signatureHelp()!.activeParameter + 1 }}
          </p>
        </div>
        }
      </div>
    </article>
  </section>

  <section class="space-y-4">
    <header class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-base-content">Execution Results</h3>
      <span class="text-sm text-base-content/70">Latest first</span>
    </header>
    @if (results().length === 0) {
    <div class="alert alert-info">
      <span>No runs yet. Write some C# and press Run to see the output.</span>
    </div>
    } @else {
    <div class="grid gap-4">
      @for (r of results(); track $index) {
      <article class="card bg-base-100 shadow-lg">
        <div class="card-body space-y-4">
          <div class="flex flex-wrap items-center gap-2">
            <span class="badge badge-primary">{{ r.outcome }}</span>
            <span class="badge badge-ghost">{{ r.durationMs }} ms</span>
            @if (r.truncated) {
            <span class="badge badge-warning badge-outline">truncated</span>
            }
          </div>

          <div class="grid gap-4 md:grid-cols-2">
            <div class="space-y-2">
              <h4 class="text-sm font-semibold uppercase tracking-wide text-base-content/70">
                stdout
              </h4>
              <pre class="code-block">{{ r.stdout || '⟨empty⟩' }}</pre>
            </div>
            <div class="space-y-2">
              <h4 class="text-sm font-semibold uppercase tracking-wide text-base-content/70">
                stderr
              </h4>
              <pre class="code-block">{{ r.stderr || '⟨empty⟩' }}</pre>
            </div>
          </div>

          @if (r.diagnostics.length > 0) {
          <div class="overflow-x-auto">
            <table class="table table-zebra table-xs">
              <thead>
                <tr class="uppercase text-xs text-base-content/70">
                  <th scope="col">Id</th>
                  <th scope="col">Severity</th>
                  <th scope="col">Line</th>
                  <th scope="col">Column</th>
                  <th scope="col">Message</th>
                </tr>
              </thead>
              <tbody>
                @for (d of r.diagnostics; track $index) {
                <tr>
                  <td class="font-mono text-xs">{{ d.id || '—' }}</td>
                  <td>{{ d.severity }}</td>
                  <td>{{ d.line }}</td>
                  <td>{{ d.column }}</td>
                  <td class="whitespace-pre-wrap">{{ d.message }}</td>
                </tr>
                }
              </tbody>
            </table>
          </div>
          }
        </div>
      </article>
      }
    </div>
    }
  </section>
</div>
